<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link 
      rel="stylesheet" 
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <title>Chat with Madhu!</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/css/bootstrap.css"
      rel="stylesheet"
    />
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #eee;
      }
      .card {
        width: 80%;
        max-width: 800px;
        overflow-y: scroll;
        max-height: 80vh;
      }
      .form-outline textarea {
        resize: none;
      }
      .btn-dark-blue {
        background-color: #00b7ee;
        border-color: #00b7ee;
        color: white;
      }

      .btn-dark-orange {
        background-color: #ff7f7f;
        border-color: #ff7f7f;
        color: white;
      }
    </style>
  </head>

  <body>
    <div class="card" id="chat1" style="border-radius: 15px">
      <div
        class="card-header d-flex justify-content-between align-items-center p-3 text-white border-bottom-0"
        style="
          border-top-left-radius: 15px;
          border-top-right-radius: 15px;
          background-color: #ff7f7f;
        "
      >
        <p class="mb-0 fw-bold">Chat with Madhu!</p>
      </div>
      <div class="card-body">
        <div class="d-flex flex-row justify-content-start mb-4">
          <img
            src="{{ url_for('static', filename='img/madhu.jpg') }}"
            alt="Madhu Avatar"
            style="width: 45px; height: 45px"
          />
          <div
            class="p-3 ms-3"
            style="border-radius: 15px; background-color: #ff7f7f"
          >
            <p class="small mb-0">Madhu: Hi there! I'm Madhu. Ready to chat?</p>
          </div>
        </div>
        {% for message in session['chat_log'] %} {% if message['role'] == 'user'
        %}
        <div class="d-flex flex-row justify-content-end mb-4">
          <img
            src="{{ url_for('static', filename='img/user.png') }}"
            alt="Your Avatar"
            style="width: 45px; height: 45px"
          />
          <div
            class="p-3 me-3 border"
            style="border-radius: 15px; background-color: #fecbcb"
          >
            <p class="small mb-0">You: {{ message['content'] }}</p>
          </div>
        </div>
        {% elif message['role'] == 'assistant' %}
        <div class="d-flex flex-row justify-content-start mb-4">
          <img
            src="{{ url_for('static', filename='img/madhu.jpg') }}"
            alt="Madhu Avatar"
            style="width: 45px; height: 45px"
          />
          <div
            class="p-3 ms-3"
            style="border-radius: 15px; background-color: #ff7f7f"
          >
            <p class="small mb-0">Madhu: {{ message['content'] }}</p>
          </div>
        </div>
        {% endif %} {% endfor %}
        <form method="POST">
          <div class="form-outline mb-3">
            <textarea
              class="form-control"
              id="user_msg"
              name="user_msg"
              rows="4"
            ></textarea>
          </div>
          <button type="button" id="start-btn" class="btn btn-dark-orange mb-3">
            <i class="fas fa-microphone"></i>
          </button>
          <button type="submit" class="btn btn-dark-orange mb-3">Send</button>
          <button
            type="submit"
            name="new_conversation"
            value="true"
            class="btn btn-dark-orange mb-3"
          >
            Start New Conversation
          </button>
        </form>
      </div>
    </div>
    <script>
      // Wait for the entire HTML document to load
      document.addEventListener("DOMContentLoaded", function() {
        // Select your chat1 div
        var chatDiv = document.getElementById("chat1");
        
        // Scroll to bottom of chat div
        chatDiv.scrollTop = chatDiv.scrollHeight;
      });
    </script>
    <script>
      // Get elements
      const startButton = document.getElementById("start-btn");
      const userMsg = document.getElementById("user_msg");
      
      // Create a new SpeechRecognition object
      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.interimResults = true;
      
      recognition.addEventListener('result', e => {
        const transcript = Array.from(e.results)
          .map(result => result[0])
          .map(result => result.transcript)
          .join('')
        
        userMsg.value = transcript;
        
        if (e.results[0].isFinal) {
          recognition.stop();
          startButton.disabled = false;
        }
      });
    
      recognition.addEventListener('end', recognition.start);
    
      startButton.addEventListener('click', () => {
        recognition.start();
        startButton.disabled = true;
      });
    </script>
  </body>
</html>
